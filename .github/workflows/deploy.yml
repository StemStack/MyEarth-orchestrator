name: Deploy to MyEarth Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, linux, hpmini]
    steps:
      - name: Deploy on hpmini
        shell: bash
        run: |
          set -e
          echo "üöÄ Starting deployment (self-hosted runner)..."
          cd /home/jc

          echo "üì• Pulling latest changes..."
          if [ -d MyEarth ]; then
            cd MyEarth
            git fetch origin
            git reset --hard origin/main
          else
            git clone https://github.com/StemStack/MyEarth.git
            cd MyEarth
          fi

          echo "üè∑  Updating version.json from footer"
          export ENVIRONMENT=production
          python3 update_version.py || true

          echo "üì¶ Rebuilding Python virtualenv..."
          rm -rf venv
          python3 -m venv venv
          source venv/bin/activate
          python -m pip install -U pip setuptools wheel
          python -m pip install -r requirements.txt

          echo "üßπ Normalize root index.html (prefer real HTML, not pointer)"
          ROOT=/home/jc/MyEarth
          CAND=$(find "$ROOT" -maxdepth 3 -type f -name index.html -printf '%s %p\n' | sort -nr | head -1 | cut -d' ' -f2-)
          if [ -n "$CAND" ]; then cp "$CAND" "$ROOT/index.html"; fi
          perl -0777 -i -pe 'BEGIN{$a=q{<script src="/static/js/buildings3d.js"></script>\n<script>try{window.Buildings3DController&&window.Buildings3DController.init(window.viewer);}catch(e){console.warn("B3D init",e)}</script>\n};} unless(/buildings3d\.js/i){ s#</body>#$a</body>#i or $_ .= "\n$a\n"; }' "$ROOT/index.html" || true

          echo "üîÑ Restarting MyEarth service..."
          sudo systemctl restart myearth

          echo "‚è≥ Waiting for service to start..."
          sleep 10

          echo "üìã Checking version:"
          curl -sL https://myearth.app/version.json || true
          echo "‚úÖ Deployment completed!"
